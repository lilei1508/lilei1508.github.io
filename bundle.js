!function(t){var e={};function i(s){if(e[s])return e[s].exports;var h=e[s]={i:s,l:!1,exports:{}};return t[s].call(h.exports,h,h.exports,i),h.l=!0,h.exports}i.m=t,i.c=e,i.d=function(t,e,s){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:s})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var s=Object.create(null);if(i.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var h in t)i.d(s,h,function(e){return t[e]}.bind(null,h));return s},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="/",i(i.s=0)}([function(t,e,i){"use strict";i.r(e);class s{constructor(){this._children=[],this._name2child={},this._eventRegistry={},this.enableEventDispatch=!1,this.visible=!0}addChild(t,e){this._children.push(e),this._name2child[t]={index:this._children.length-1,obj:e}}removeChild(t){this._name2child[t]&&(this._children.splice(this._name2child[t].index,1),delete this._name2child[t])}getChild(t){return this._name2child[t].obj}forEachChild(t){for(let e of Object.keys(this._name2child))t(e,this._name2child[e].obj)}clearAll(){this._name2child={},this._children=[]}resetEvent(){this._eventRegistry={},this.enableEventDispatch=!1}draw(t){if(this.visible)for(let e of this._children)e.draw(t)}addEventListener(t,e){if("[object Array]"===Object.prototype.toString.call(t))for(let i of t)this._eventRegistry[i]=e;else this._eventRegistry[t]=e}dispatchEvent(t,e){if(!this.enableEventDispatch)return;let i=this._eventRegistry[t];i&&i(e)}}class h extends s{constructor(t){super(),this.fontFamily=t.fontFamily?t.fontFamily:"sans-serif",this.fontSize=t.fontSize?t.fontSize:20,this.font=this.fontSize+"px "+this.fontFamily,this.x=t.x,this.y=t.y,this.width=t.width,this.color=t.color?t.color:"0x000000",this.setText(t.text),this.visible=!0}setText(t){if(this.text=t,!this.width)return;let e=parseInt(this.width/this.fontSize),i=[],s="",h=1;for(let t of this.text)s+=t,h++%e==0&&(i.push(s),s="");0!=s.length&&i.push(s),this.lines=i}draw(t){if(!this.visible)return;let e=t.fillStyle,i=t.font;if(t.fillStyle=this.color,t.font=this.font,this.lines)for(let e=0;e<this.lines.length;e++)t.fillText(this.lines[e],this.x,this.y+e*this.fontSize);else t.fillText(this.text,this.x,this.y);t.font=i,t.fillStyle=e}}var r={common:{screenWidth:()=>window.innerWidth,screenHeight:()=>window.innerHeight},dom:{createImage:()=>document.createElement("img"),craeteCanvas(t,e){let i=document.createElement("canvas");return i.width=t,i.height=e,i.style="position: absolute;margin:auto;left:0;right:0;top:0;bottom:0;",document.body.appendChild(i),i}},extra:{showFPS(t){if(this.fpsPreTime){this.fpsIndex++;let e=Date.now(),i=e-this.fpsPreTime;this.fpsPreTime=e,this.fpsIndex%60==0&&(this.fpsTextView.text="FPS:"+parseInt(1e3/i)),this.fpsTextView.draw(t)}else this.fpsPreTime=Date.now(),this.fpsIndex=0,this.fpsTextView=new h({text:"",fontSize:"16",x:2,y:14})}}};let a={canvasWidth(){let t=r.common.screenWidth();return t>480?480:t},canvasHeight:()=>r.common.screenHeight(),downSpeed:()=>5};console.log("屏幕宽高:"+r.common.screenWidth()+","+r.common.screenHeight()),console.log("初始画布宽高:"+a.canvasWidth()+","+a.canvasHeight());var o=a;class l{constructor(){this._queue=[],this._loadedCount=0}loadedCount(){return this._loadedCount}allCount(){return this._queue.length}push(t){this._queue.push(t)}pushImage(t,e){this._queue.push({url:t,type:"image",callback:e})}start(t,e){for(let i of this._queue){if("image"!==i.type)throw"illegal type "+i.type;{let s=r.dom.createImage();s.onload=()=>{i.callback&&i.callback(s),this._oneTaskDone(i,t,e)},s.src=i.url}}}_oneTaskDone(t,e,i){this._loadedCount+=1,this._loadedCount===this._queue.length&&e&&e(),i&&i(t)}}class n extends s{constructor(t,e=0,i=0,s=0,h=0){if(super(),!t)throw"img object is null.";this.img=t,this.width=e,this.height=i,this.x=s,this.y=h,this.visible=!0}draw(t){this.visible&&t.drawImage(this.img,this.x,this.y,this.width,this.height)}addEventListener(t,e){this.enableEventDispatch=!0,super.addEventListener(t,t=>{let i=t.x,s=t.y;i>=this.x&&i<=this.x+this.width&&s>=this.y&&s<=this.y+this.height&&e(t)})}}class c extends s{constructor(){super()}setBackgroundImage(t){this.backgroundImage=t,this.addChild("SCENE_BG",new n(this.backgroundImage,o.canvasWidth(),o.canvasHeight(),0,0))}dispatchEvent(t,e){super.dispatchEvent(t,e);for(let i of this._children)i.dispatchEvent(t,e)}}class d extends c{constructor(t){super(),this.ready=!1,this.visible=!1;let e=new l;e.pushImage("assets/images/bg.png",(t,e)=>this.BG_IMG=t),e.pushImage("assets/images/start-game.png",t=>this.START_IMG=t),e.start(()=>{this.setBackgroundImage(this.BG_IMG);let e=o.canvasWidth(),i=o.canvasHeight();this.startBtn=new n(this.START_IMG,100,100,(e-100)/2,(i-100)/2),this.startBtn.addEventListener(["touchstart","mousedown"],(function(){t.changeScene("game"),t.name2scene.game.startGame()})),this.startBtn.visible=this.ready,this.addChild("start",this.startBtn),this.visible=!0})}mainInitFinish(){this.startBtn?this.startBtn.visible=!0:this.ready=!0}}class p extends s{constructor(t=0,e=0){super(),this.x=t,this.y=e,this.visible=!0,this.alpha=1,this.color="#000000",this.shape=void 0}fillRect(t,e,i,s){this.shape=h=>{let r=h.globalAlpha,a=h.fillStyle;h.globalAlpha=this.alpha,h.fillStyle=this.color,h.alpha=this.alpha,h.fillRect(this.x+t,this.y+e,i,s),h.globalAlpha=r,h.fillStyle=a}}draw(t){this.visible&&this.shape&&this.shape(t)}}class u extends c{constructor(t,e){super(),this.res=t,this.main=e}createMainArea(){this.horizontalBlockNum=10;let t=.05*this.leftAreaWidth;this.mainWidth=this.leftAreaWidth-2*t,this.mainHeight=o.canvasHeight()-2*t,this.mainX=t,this.mainY=t;let e=new p(this.mainX,this.mainY);e.color="#0x000000",e.alpha=.5,e.fillRect(0,0,this.mainWidth,this.mainHeight),this.addChild("main",e)}createAllBlock(){let t=(this.mainWidth-8-1*(this.horizontalBlockNum-1))/this.horizontalBlockNum,e=t,i=(this.mainHeight-8-1)/(1+e);i=parseInt(i),this.verticalNum=i,this.blockTable=[];for(let e=0;e<i;e++){let i=[];for(let s=0;s<this.horizontalBlockNum;s++){let h=this.mainX+4+s*(1+t),r=this.mainY+4+e*(1+t),a=new p(h,r);a.color="#000000",a.visible=!1,a.fillRect(0,0,t,t),this.addChild("block_"+e+"_"+s,a),i.push({shape:a,group:-1})}this.blockTable.push(i)}}createScoreBoard(){let t=this.rightAreaWidth-6,e=t/4,i=3+this.rightAreaX,s=new p(i,20);s.color="#0x000000",s.alpha=.5,s.fillRect(0,0,t,e),this.addChild("scoreboard",s);let r=e-4,a=new h({text:"0",color:"#ffff00",x:i+4,y:20+r,fontSize:r});this.scoreText=a,this.addChild("scoreText",a)}createTimeArea(){let t=this.rightAreaWidth-6,e=t/4,i=3+this.rightAreaX,s=new p(i,60);s.color="#0x000000",s.alpha=.5,s.fillRect(0,0,t,e),this.addChild("timeArea",s);let r=e-4,a=new h({text:"00:00",color:"#ffff00",x:i+4,y:60+r,fontSize:r});this.timeText=a,this.addChild("timeText",a)}createPreviewArea(){this.previewWidth=this.rightAreaWidth-6,this.previewHeight=this.previewWidth,this.previewX=3+this.rightAreaX,this.previewY=100;let t=new p(this.previewX,this.previewY);t.color="#0x000000",t.alpha=.5,t.fillRect(0,0,this.previewWidth,this.previewWidth),this.addChild("preview",t)}createHelpArea(){let t=this.rightAreaWidth-6,e=t,i=3+this.rightAreaX,s=new p(i,250);s.color="#0x000000",s.alpha=.5,s.fillRect(0,0,t,e),this.addChild("helpArea",s);let r=t/6-2,a=new h({text:"方向键上变换形状、方向键左右移动方块、方向键下加速下落",color:"#ff0000",x:i+4,y:250+r,width:t,fontSize:r});this.addChild("helpText",a)}createOperationArea(){let t=this.rightAreaWidth-6,e=t,i=3+this.rightAreaX,s=new n(this.res.IMG_DIRECTION,t,e,i,450);this.addChild("op",s);let h=t/3;s.addEventListener(["touchstart","mousedown"],e=>{e.x>=i+h&&e.x<=i+2*h&&e.y>=450&&e.y<=450+h?this.changeShape():e.x>=i+2*h&&e.x<=i+t&&e.y>=450+h&&e.y<=450+2*h?this.currentBlockShape&&this.currentBlockShape.rightPos<this.horizontalBlockNum-1&&(this.moveBlock(t=>{t[1]+=1}),this.currentBlockShape.leftPos+=1,this.currentBlockShape.rightPos+=1):e.x>=i+h&&e.x<=i+2*h&&e.y>=450+2*h&&e.y<=450+t?this.currentBlockShape&&this.blockDown():e.x>=i&&e.x<=i+h&&e.y>=450+h&&e.y<=450+2*h&&this.currentBlockShape&&this.currentBlockShape.leftPos>0&&(this.moveBlock(t=>{t[1]-=1}),this.currentBlockShape.leftPos-=1,this.currentBlockShape.rightPos-=1)})}startGame(){this.downSpeed=100*o.downSpeed(),this.clearAll(),this.resetEvent(),this.setBackgroundImage(this.res.BG_IMG),this.leftAreaWidth=.7*o.canvasWidth(),this.createMainArea(),this.createAllBlock(),this.rightAreaWidth=.3*o.canvasWidth(),this.rightAreaX=this.leftAreaWidth,this.createScoreBoard(),this.createTimeArea(),this.createPreviewArea(),this.createHelpArea(),this.createOperationArea(),this.GROUP_ID_SEED=0,this.initBlockShapes(),this.startGameTimer(),this.generateNextBlockShape()}startGameTimer(){this.ms=0,this.score=0,this.colorArr=["#FF0000","#FF4500","#9400D3","#8B5A00","#1874CD","#008B00"];let t=this.tick.bind(this);this.intervalId=setInterval(t,100)}gameOver(){clearInterval(this.intervalId);let t=o.canvasWidth()/4*3,e=(o.canvasWidth()-t)/2,i=(o.canvasHeight()-t)/2,s=new p(e,i);s.alpha=.8,s.color="#000000",s.fillRect(0,0,t,t),s.visible=!0,s.enableEventDispatch=!0,s.addEventListener(["touchstart","mousedown"],t=>{this.clearAll(),this.resetEvent(),this.main.changeScene("launch")}),this.addChild("overBoard",s);let r=t/5-4,a=i+2*r+10,l=new h({text:"游戏结束",color:"#ffff00",x:e+(t-4*r)/2,y:a,fontSize:r});this.addChild("failed",l);let n=a+(r=t/8-4)+20,c="得分："+this.score,d=new h({text:c,color:"#ffff00",x:e+(t-r*c.length)/2,y:n,fontSize:r});this.addChild("finalScore",d);let u=new h({text:"点击任意区域重新开始游戏",color:"#ffff00",x:e+(t-(r=t/16-4)*(c="点击任意区域重新开始游戏").length)/2,y:n+r+20,fontSize:r});this.addChild("tips",u)}nextGroupId(){return++this.GROUP_ID_SEED}tick(){if(this.ms+=100,this.timeText.text=this.calTimeStr(parseInt(this.ms/1e3)),this.scoreText.text=this.score+"",this.ms%this.downSpeed==0)if(this.currentBlockShape)this.blockDown();else{this.currentBlockShape=this.nextShape;for(let t of this.currentBlockShape.blockPosArr){let e=this.blockTable[t[0]][t[1]];if(e.shape.visible)return void this.gameOver();e.shape.visible=!0,e.group=this.currentBlockShape.groupId,e.shape.color=this.currentBlockShape.color,t.push(this.currentBlockShape.groupId)}this.generateNextBlockShape()}}blockDown(){this.checkState()?this.currentBlockShape=null:this.moveBlock(t=>{t[0]+=1})}calTimeStr(t){let e=t%60;e<10&&(e="0"+e);let i=parseInt(t/60);return i<10&&(i="0"+i),i+":"+e}moveBlock(t){if(!this.currentBlockShape)return;let e=-1;for(let i of this.currentBlockShape.blockPosArr){let s=this.blockTable[i[0]][i[1]];e=s.group,s.shape.visible=!1,s.group=-1,t(i)}for(let t of this.currentBlockShape.blockPosArr){let i=this.blockTable[t[0]][t[1]];i.shape.color=this.currentBlockShape.color,i.shape.visible=!0,i.group=e}}changeShape(){for(let t of this.currentBlockShape.blockPosArr){let e=this.blockTable[t[0]][t[1]];e.shape.visible=!1,e.group=-1}this.currentBlockShape.rotateFunc(this.currentBlockShape);for(let t of this.currentBlockShape.blockPosArr){let e=this.blockTable[t[0]][t[1]];e.shape.visible=!0,e.group=t[2],e.shape.color=this.currentBlockShape.color}}checkState(){let t=!1;for(let e of this.currentBlockShape.blockPosArr)if(!t){if(e[0]+1>=this.verticalNum){t=!0;continue}let i=this.blockTable[e[0]][e[1]],s=this.blockTable[e[0]+1][e[1]];i.group!==s.group&&s.shape.visible&&(t=!0)}if(t){let t=Number.MAX_SAFE_INTEGER,e=Number.MIN_SAFE_INTEGER;for(let i of this.currentBlockShape.blockPosArr)t=i[0]<t?i[0]:t,e=i[0]>e?i[0]:e;let i=0,s=.5;for(;t<=e;t++){let e=!0;for(let i of this.blockTable[t])if(!i.shape.visible){e=!1;break}if(e){for(let e=t;e>0;e--)for(let t=0;t<this.horizontalBlockNum;t++){let i=this.blockTable[e][t],s=this.blockTable[e-1][t];i.group=s.group,i.shape.visible=s.shape.visible,s.group=-1,s.shape.visible=!1}i+=10,s+=.5}}this.score+=i*s}return t}generateNextBlockShape(){let t=parseInt(19*Math.random()+1),e=this.colorArr[parseInt(Math.random()*this.colorArr.length)],i=this.nextGroupId();this.nextShape=this.newBlockShapes(t),this.nextShape.color=e,this.nextShape.groupId=i,this.previewShape&&(this.previewShape.visible=!1),this.previewShape=this.getChild("preview-"+t),this.previewShape.forEachChild((t,i)=>{i.color=e}),this.previewShape.visible=!0}initBlockShapes(){this.blockShapeFactorys=[],this._newBlockShapeFactory(()=>[[0,3],[0,4],[0,5],[0,6]],2),this._newBlockShapeFactory(()=>[[0,5],[1,5],[2,5],[3,5]],1),this._newBlockShapeFactory(()=>[[0,4],[1,3],[1,4],[1,5]],2),this._newBlockShapeFactory(()=>[[1,5],[0,4],[1,4],[2,4]],2),this._newBlockShapeFactory(()=>[[1,4],[0,3],[0,4],[0,5]],2),this._newBlockShapeFactory(()=>[[1,4],[0,5],[1,5],[2,5]],2),this._newBlockShapeFactory(()=>[[0,4],[0,5],[1,4],[1,5]],-1),this._newBlockShapeFactory(()=>[[0,3],[0,4],[1,4],[1,5]],1),this._newBlockShapeFactory(()=>[[0,5],[1,5],[1,4],[2,4]],1),this._newBlockShapeFactory(()=>[[0,4],[0,5],[1,3],[1,4]],0),this._newBlockShapeFactory(()=>[[0,4],[1,4],[1,5],[2,5]],1),this._newBlockShapeFactory(()=>[[0,4],[1,4],[2,4],[2,5]],1),this._newBlockShapeFactory(()=>[[0,3],[0,4],[0,5],[1,5]],1),this._newBlockShapeFactory(()=>[[0,5],[1,5],[2,5],[0,4]],1),this._newBlockShapeFactory(()=>[[1,3],[1,4],[1,5],[0,5]],1),this._newBlockShapeFactory(()=>[[0,5],[1,5],[2,5],[2,4]],1),this._newBlockShapeFactory(()=>[[1,3],[1,4],[1,5],[0,3]],1),this._newBlockShapeFactory(()=>[[0,4],[1,4],[2,4],[0,5]],1),this._newBlockShapeFactory(()=>[[0,3],[0,4],[0,5],[1,5]],1)}_newBlockShapeFactory(t,e){let i,h=t(),r=Number.MAX_SAFE_INTEGER,a=Number.MIN_SAFE_INTEGER,o=Number.MAX_SAFE_INTEGER,l=Number.MIN_SAFE_INTEGER;for(let t of h)t[1]<r&&(r=t[1]),t[1]>a&&(a=t[1]),t[0]<o&&(o=t[0]),t[0]>l&&(l=t[0]);i=e<0?t=>{}:t=>{let e=t.blockPosArr[t.rotateIndex],i=e[0],s=e[1],h=!0;for(let e=0;e<4;e++){let r=t.blockPosArr[e][0],a=t.blockPosArr[e][1]-s+i,o=i-r+s;if(a<0||a>=this.verticalNum){h=!1;break}if(o<0||o>=this.horizontalBlockNum){h=!1;break}if(this.blockTable[a][o].shape.visible){h=!1;break}}if(!h)return;let r=this.horizontalBlockNum,a=0;for(let e=0;e<4;e++){let h=t.blockPosArr[e][0],o=t.blockPosArr[e][1]-s+i,l=i-h+s;r>l&&(r=l),a<l&&(a=l),t.blockPosArr[e][0]=o,t.blockPosArr[e][1]=l}t.leftPos=r,t.rightPos=a};let n=this.previewWidth,c=n/6,d=(l-o+1)*c,u=this.previewY+(n-d)/2,f=(a-r+1)*c,m=this.previewX+(n-f)/2,g=new s;for(let t=0;t<h.length;t++){let e=(h[t][1]-r)*c+m,i=(h[t][0]-o)*c+u,s=new p(e,i);s.color="#00ff00",s.fillRect(0,0,c,c),g.addChild(t,s)}g.visible=!1,this.addChild("preview-"+(this.blockShapeFactorys.length+1),g);let b={create:()=>({blockPosArr:t(),leftPos:r,rightPos:a,rotateIndex:e,rotateFunc:i})};this.blockShapeFactorys.push(b)}newBlockShapes(t){return this.blockShapeFactorys[t-1].create()}}const f=r.dom.craeteCanvas(o.canvasWidth(),o.canvasHeight()),m=f.getContext("2d");(new class{constructor(){this.bindLoop=this.loop.bind(this),this.currentScene=null,this.name2scene={}}start(){this.registerEvents();let t=new d(this);this.name2scene.launch=t,this.currentScene=t,window.cancelAnimationFrame(this.aniId),this.aniId=window.requestAnimationFrame(this.bindLoop),this.res={};let e=new l;e.pushImage("assets/images/bg.png",t=>this.res.BG_IMG=t),e.pushImage("assets/images/direction.png",t=>this.res.IMG_DIRECTION=t),e.start(()=>{this.name2scene.game=new u(this.res,this),t.mainInitFinish()},t=>{console.log("加载 "+t.type+" "+t.url+" 完成.")})}changeScene(t){this.currentScene=this.name2scene[t]}registerEvents(){f.addEventListener("touchstart",t=>{this.currentScene&&this.currentScene.dispatchEvent("touchstart",{src:t,x:t.touches[0].clientX,y:t.touches[0].clientY})}),f.addEventListener("mousedown",t=>{let e=f.getBoundingClientRect(),i=Math.round(t.clientX-e.left),s=Math.round(t.clientY-e.top);this.currentScene&&this.currentScene.dispatchEvent("mousedown",{src:t,x:i,y:s})})}draw(){m.clearRect(0,0,f.width,f.height),this.currentScene.draw(m)}loop(){this.draw(),r.extra.showFPS(m),this.aniId=window.requestAnimationFrame(this.bindLoop)}}).start()}]);
//# sourceMappingURL=bundle.js.map